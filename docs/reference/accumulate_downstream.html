<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Accumulate Variable Downstream — accumulate_downstream • hydroloom</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Accumulate Variable Downstream — accumulate_downstream"><meta name="description" content="given a variable, accumulate according to network topology.
See details for required attributes and additional information."><meta property="og:description" content="given a variable, accumulate according to network topology.
See details for required attributes and additional information."><meta property="og:image" content="https://doi-usgs.github.io/hydroloom/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">hydroloom</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/hydroloom.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/accumulate_downstream.html">Downstream Accumulation</a></li>
    <li><a class="dropdown-item" href="../articles/advanced_network.html">Topological Sort Based Network Attributes</a></li>
    <li><a class="dropdown-item" href="../articles/flow-table.html">NHD Flow Table with Hydroloom</a></li>
    <li><a class="dropdown-item" href="../articles/network_navigation.html">Network Navigation</a></li>
    <li><a class="dropdown-item" href="../articles/non-dendritic.html">Non-dendritic networks</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/DOI-USGS/hydroloom/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Accumulate Variable Downstream</h1>
      <small class="dont-index">Source: <a href="https://github.com/DOI-USGS/hydroloom/blob/HEAD/R/accumulate_downstream.R" class="external-link"><code>R/accumulate_downstream.R</code></a></small>
      <div class="d-none name"><code>accumulate_downstream.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>given a variable, accumulate according to network topology.
See details for required attributes and additional information.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">accumulate_downstream</span><span class="op">(</span><span class="va">x</span>, <span class="va">var</span>, total <span class="op">=</span> <span class="cn">FALSE</span>, quiet <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'data.frame'</span></span>
<span><span class="fu">accumulate_downstream</span><span class="op">(</span><span class="va">x</span>, <span class="va">var</span>, total <span class="op">=</span> <span class="cn">FALSE</span>, quiet <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'hy'</span></span>
<span><span class="fu">accumulate_downstream</span><span class="op">(</span><span class="va">x</span>, <span class="va">var</span>, total <span class="op">=</span> <span class="cn">FALSE</span>, quiet <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>data.frame network compatible with <a href="hydroloom_names.html">hydroloom_names</a>.</p></dd>


<dt id="arg-var">var<a class="anchor" aria-label="anchor" href="#arg-var"></a></dt>
<dd><p>variable to accumulate.</p></dd>


<dt id="arg-total">total<a class="anchor" aria-label="anchor" href="#arg-total"></a></dt>
<dd><p>logical if TRUE, accumulation will use "total" apportionment
if FALSE, divergence or dendritic apportionment will apply ( see details).</p></dd>


<dt id="arg-quiet">quiet<a class="anchor" aria-label="anchor" href="#arg-quiet"></a></dt>
<dd><p>logical quiet messages?</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>vector of the same length as <code>nrow(x)</code> containing values of <code>var</code> accumulated downstream</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Required attributes: <code>id</code> and <code>toid</code> or <code>fromnode</code>, <code>tonode</code>, and <code>divergence</code></p>
<p>Conditionally: <code>divergence_fraction</code>
(if divergence apportioned routing is desired).</p>
<p>Accumulation Methods:</p>
<p>Divergence apportioned (divergence routing): Where upstream values are passed with
fractional apportionment such that each downstream connection gets between
0 and 100 percent of the upstream value. Requires a "divergence_fraction"
attribute and the "total" parameter to be <code>FALSE</code>.</p>
<p>Dendritic apportionment (no divergence routing): Where upstream values are not passed to
secondary paths at all – this is essentially a special case of divergence
apportioned where no diversion fraction value is provided and 0 is
assumed for all divergences. Do not include a "divergence_fraction" and
set "total" to <code>FALSE</code>.</p>
<p>No apportionment (total upstream): where upstream values are passed without being
apportioned such that each downstream connection gets the full upstream
value and there is special handling where diversions join back to the main
flow to avoid double counting. This is also referred to as
"total upstream routing". Set "total" to TRUE.</p>
<p>"No apportionment" (total upstream) routing includes considerably more logic
and requires a noteable amount more computation to avoid double counting
through systems of diverted channels. The implementation has been tested
to match the total drainage area calculations of NHDPlusV2.</p>
<p>When flow splits at a diversion, the duplicated part is tracked until it
recombines with the non-duplicated part. In this tracking, both nested
diversions and diversions that have two or more flow splits in one place
are supported. For this algorithm to work, it is critical that the supplied
data be a directed acyclic graph and have a complete divergence attribute
where 0 indicates no diversion, 1 indicates the main catchment downstream
of a diversion and 2 indicates a secondary (one or more) downstram of a
diversion.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/new_hope.gpkg"</span>, package <span class="op">=</span> <span class="st">"hydroloom"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">net</span> <span class="op">&lt;-</span> <span class="fu"><a href="navigate_network_dfs.html">navigate_network_dfs</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">8893236</span>, <span class="st">"up"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="va">x</span><span class="op">$</span><span class="va">COMID</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">net</span><span class="op">)</span>, <span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># All default gives dendritic routing</span></span></span>
<span class="r-in"><span><span class="va">x</span><span class="op">$</span><span class="va">dend_totdasqkm</span> <span class="op">&lt;-</span> <span class="fu">accumulate_downstream</span><span class="op">(</span><span class="fu"><a href="add_toids.html">add_toids</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="st">"AreaSqKM"</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Dendritic routing will be applied. Diversions are assumed to have 0 flow fraction.</span>
<span class="r-in"><span><span class="va">x</span><span class="op">$</span><span class="va">diff</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">TotDASqKM</span> <span class="op">-</span> <span class="va">x</span><span class="op">$</span><span class="va">dend_totdasqkm</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># notice that diversions reset as if they were headwaters</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="st">'dend_totdasqkm'</span><span class="op">]</span>, lwd <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">dend_totdasqkm</span> <span class="op">/</span> <span class="fl">20</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="accumulate_downstream-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># add a diversion_fraction that splits flow evenly</span></span></span>
<span class="r-in"><span><span class="co"># max(dplyr::n()) is the number of flowlines in a FromNode group.</span></span></span>
<span class="r-in"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">FromNode</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>divergence_fraction <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">y</span><span class="op">$</span><span class="va">div_totdasqkm</span> <span class="op">&lt;-</span> <span class="fu">accumulate_downstream</span><span class="op">(</span><span class="va">y</span>, <span class="st">"AreaSqKM"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># notice that diversions don't reset -- they carry a fraction of area</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="st">'div_totdasqkm'</span><span class="op">]</span>, lwd <span class="op">=</span> <span class="va">y</span><span class="op">$</span><span class="va">div_totdasqkm</span> <span class="op">/</span> <span class="fl">20</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="accumulate_downstream-2.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># total not implemented yet, but will be soon</span></span></span>
<span class="r-in"><span><span class="va">z</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">COMID</span>, <span class="va">FromNode</span>, <span class="va">ToNode</span>, <span class="va">Divergence</span>, <span class="va">AreaSqKM</span>, <span class="va">TotDASqKM</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">z</span><span class="op">$</span><span class="va">tot_totdasqkm</span> <span class="op">&lt;-</span> <span class="fu">accumulate_downstream</span><span class="op">(</span><span class="va">z</span>, <span class="st">"AreaSqKM"</span>, total <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">z</span><span class="op">[</span><span class="st">'tot_totdasqkm'</span><span class="op">]</span>, lwd <span class="op">=</span> <span class="va">z</span><span class="op">$</span><span class="va">tot_totdasqkm</span> <span class="op">/</span> <span class="fl">20</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="accumulate_downstream-3.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># equivalent values from the nhdplusv2 match!</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">z</span><span class="op">$</span><span class="va">tot_totdasqkm</span> <span class="op">-</span> <span class="va">z</span><span class="op">$</span><span class="va">TotDASqKM</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0.001</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] FALSE</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by David Blodgett.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

