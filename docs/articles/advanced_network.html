<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="hydroloom">
<title>Topological Sort Based Network Attributes • hydroloom</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Topological Sort Based Network Attributes">
<meta property="og:description" content="hydroloom">
<meta property="og:image" content="https://doi-usgs.github.io/hydroloom/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">hydroloom</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/hydroloom.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/advanced_network.html">Topological Sort Based Network Attributes</a>
    <a class="dropdown-item" href="../articles/flow-table.html">NHD Flow Table with Hydroloom</a>
    <a class="dropdown-item" href="../articles/non-dendritic.html">Non-dendritic networks</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Topological Sort Based Network Attributes</h1>
                        <h4 data-toc-skip class="author"><a href="mailto:dblodgett@usgs.gov" class="email">dblodgett@usgs.gov</a></h4>
            
      
      
      <div class="d-none name"><code>advanced_network.Rmd</code></div>
    </div>

    
    
<div class="section level4">
<h4 id="terminology">Terminology<a class="anchor" aria-label="anchor" href="#terminology"></a>
</h4>
<p>The terms used below are derived from concepts of <a href="https://en.wikipedia.org/wiki/Graph_theory" class="external-link">graph theory</a>, the
<a href="http://opengeospatial.github.io/HY_Features/" class="external-link">HY_Features</a>
data model, and the <a href="https://www.epa.gov/waterdata/nhdplus-national-hydrography-dataset-plus" class="external-link">NHDPlus</a>
data model. Many of the concepts here are also presented in: <a href="https://pubs.er.usgs.gov/publication/70216698" class="external-link">Mainstems: A
logical data model implementing <em>mainstem</em> and <em>drainage</em>
basin feature types based on WaterML2 Part 3: HY Features
concepts</a>.</p>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The NHDPlus data model, which the attributes described here are based
on, includes many ‘value added attributes’ (VAA). This vignette
discusses a core set of VAA’s that <code>hydroloom</code> can create
from readily available hydrographic inputs. The vignette begins with a
background needed to understand what these attributes are, and then
demonstrates how to create them based on some sample input data. These
attributes are documented in the <a href="https://www.epa.gov/waterdata/nhdplus-national-hydrography-dataset-plus" class="external-link">NHDPlus
manual</a>, and every effort has been made to faithfully implement their
meaning.</p>
<p>While the <code>hydroloom</code> package contains other functions to
generate network attributes, (e.g. <code><a href="../reference/add_pfafstetter.html">add_pfafstetter()</a></code> for
Pfafstetter codes and <code><a href="../reference/add_streamorder.html">add_streamorder()</a></code> for stream orders)
this vignette focuses on the network attributes from the NHDPlus data
model that revolve around the <strong>topo_sort</strong> and
<strong>levelpath</strong>. In the NHDPlus data model,
<strong>topo_sort</strong> is referred to as
<strong>hydrosequence</strong> but it is functionally equivalent to a
topological sort and is referred to as topo_sort in
<code>hydroloom</code>.</p>
<div class="section level3">
<h3 id="representing-network-topology">Representing Network Topology<a class="anchor" aria-label="anchor" href="#representing-network-topology"></a>
</h3>
<p>A network of flowlines can be represented as an edge-to-edge
(e.g. edge list) or edge-node topology. An edge list only expresses the
connectivity between <em>edges</em> (flowlines in the context of
rivers), requiring <em>nodes</em> (confluences in the context of rivers)
to be inferred.</p>
<pre><code><span><span class="co">#&gt;  ID toID fromnode tonode</span></span>
<span><span class="co">#&gt;   1    3       N1     N3</span></span>
<span><span class="co">#&gt;   2    3       N2     N3</span></span>
<span><span class="co">#&gt;   3   NA       N3     N4</span></span></code></pre>
<div class="figure" style="text-align: center">
<img src="advanced_network_files/figure-html/node-1.png" alt="In an edge-node topology, edges are directed to nodes which are then directed to other edges. An edge-to-edge toplogy does not include intervening nodes." width="45%"><img src="advanced_network_files/figure-html/node-2.png" alt="In an edge-node topology, edges are directed to nodes which are then directed to other edges. An edge-to-edge toplogy does not include intervening nodes." width="45%"><p class="caption">
In an edge-node topology, edges are directed to nodes which are then
directed to other edges. An edge-to-edge toplogy does not include
intervening nodes.
</p>
</div>
<p>The “toID” of a terminal flowline can be either NA or, by convention,
0 or ““. Using 0 or an empty string is preferred within
<code>hydroloom</code> but both are handled in most cases. Further, as
long as 0 is not in the set of IDs, there is little practical
difference.</p>
<p>In <code>hydroloom</code>, edge-to-edge topology is referred to with
“id and toid” attributes.</p>
</div>
<div class="section level3">
<h3 id="topo_sort">topo_sort<a class="anchor" aria-label="anchor" href="#topo_sort"></a>
</h3>
<div class="figure" style="text-align: center">
<img src="advanced_network_files/figure-html/sort-1.png" alt="Smaller 'topo_sort' values are guaranteed to be downstream of larger values along connected paths." width="288"><p class="caption">
Smaller ‘topo_sort’ values are guaranteed to be downstream of larger
values along connected paths.
</p>
</div>
<p>The NHDPlus data model includes an attribute called
<em>hydrosequence</em> that is functionally a <a href="https://en.wikipedia.org/wiki/Topological_sorting" class="external-link">topological
sort</a> of the flowline network. It provides an integer identifier
guaranteed to decrease in the downstream direction. For flowlines that
are not connected by a single direction navigation (e.g. parallel
tributaries) the topo_sort has no significance. However, when two
flowlines have a direct navigation, the downstream flowline will always
have the smaller topo_sort. <code>hydroloom</code> supports creation of
topo_sort with the <code><a href="../reference/sort_network.html">sort_network()</a></code> function.</p>
<p>It is hard to overstate the importance of topo_sort, as <em>any</em>
function that requires understanding upstream-downstream relationships
requires a sorted version of the flowline network. In the NHDPlus data
model, a dendritic edge-list topology is stored in the form of a
topo_sort and ‘down topo_sort’ attribute. The equivalent is available in
<code>hydroloom</code>, but does not use the to topo_sort convention,
preferring the primary identifier (id) and an accompanying toid to store
a dendritic edge list.</p>
</div>
<div class="section level3">
<h3 id="level-path">Level Path<a class="anchor" aria-label="anchor" href="#level-path"></a>
</h3>
<div class="figure" style="text-align: center">
<img src="advanced_network_files/figure-html/lp-1.png" alt="Levelpath values are constant along mainstem paths and are derived from the topo_sort of their outlet flowline." width="288"><p class="caption">
Levelpath values are constant along mainstem paths and are derived from
the topo_sort of their outlet flowline.
</p>
</div>
<p>A level path is derived from “stream level” which assigns an integer
value to mainstem rivers from outlet up the network (see NHDPlus
documentation for more). Rivers terminating to the ocean are given level
1 and this level extends all the way to the headwaters. Rivers
terminating in level 1 rivers are given level 2, and so on.</p>
<p>“Stream leveling” is the process of establishing uniquely identified
“level paths” through a stream network. This is accomplished with a set
of rules that determine which tributary should be considered dominant at
every confluence to establish the “mainstem rivers” for each “drainage
basin” in a network. <code>hydroloom</code> supports creation of stream
level with the <code><a href="../reference/add_streamlevel.html">add_streamlevel()</a></code> function, and the creation
of level path with <code><a href="../reference/add_levelpaths.html">add_levelpaths()</a></code>. <code>hydroloom</code>
adopts the convention used in NHDPlus, to assign the levelpath as the
topo_sort of the path’s outlet.</p>
<p>See <a href="https://pubs.er.usgs.gov/publication/70216698" class="external-link">Mainstems: A
logical data model implementing <em>mainstem</em> and <em>drainage</em>
basin feature types based on WaterML2 Part 3: HY Features concepts</a>
for an in depth discussion of these concepts.</p>
</div>
<div class="section level3">
<h3 id="other-derived-network-attributes">Other Derived Network Attributes<a class="anchor" aria-label="anchor" href="#other-derived-network-attributes"></a>
</h3>
<p>A number of additional attributes can be derived once
<code>levelpath</code> and <code>topo_sort</code> are established. These
include: (note that precise attribute names have not been used here)</p>
<ol style="list-style-type: decimal">
<li>
<strong>terminal path</strong>: the identifier (topo_sort or primary
id) of the terminal flowline of network.</li>
<li>
<strong>up topological sort</strong>: the identifier of the upstream
flowline on the mainstem</li>
<li>
<strong>down topological sort</strong>: the identifier of the
downstream flowline on the mainstem</li>
<li>
<strong>up level path</strong>: the identifier of the next upstream
levelpath on the mainstem</li>
<li>
<strong>down level path</strong>: the identifier of the next
downstream levelpath on the mainstem</li>
<li>
<strong>path length</strong>: The distance to the network outlet
downstream along the main path.</li>
<li>
<strong>total drainage area:</strong> Total accumulated area from
upstream flowline’s catchment area.</li>
<li>
<strong>arbolate sum:</strong> The total accumulated length of
upstream flowlines.</li>
<li>
<strong>terminal flag:</strong> A simple 0 or 1 indicating whether a
flowline is a terminal path or not.</li>
</ol>
</div>
<div class="section level3">
<h3 id="required-base-attributes">Required Base Attributes<a class="anchor" aria-label="anchor" href="#required-base-attributes"></a>
</h3>
<p>Creating levelpath and topo_sort identifiers requires a set of base
attributes that include:</p>
<ol style="list-style-type: decimal">
<li><p><strong><code>fromnode</code> / <code>tonode</code></strong> or
<strong><code>id</code> / <code>toid</code></strong>: from and to nodes
can be used to generate an edge to edge flowline topology.</p></li>
<li><p><strong><code>length</code>:</strong> a length is required for
each flowline in the network to determine a flow distance, and if using
the arbolate sum for stream leveling.</p></li>
<li><p><strong><code>area</code>:</strong> the local drainage area of
each flowline is useful in many contexts but is primarily used to
calculate total drainage area.</p></li>
<li><p><strong><code>weight_attribute</code>:</strong> a weight metric
is required for stream leveling to determine the dominant upstream
flowline. In the NHD, the arbolate sum is used. However, alternative
metrics (e.g. total drainage area) can be used instead.</p></li>
<li><p><strong><code>name_attribute</code>:</strong> Many times, it is
preferable to follow a consistently named path rather than a strict
physical weight when stream leveling. In these cases a
<code>name_attribute</code> can be provided.</p></li>
<li><p><strong><code>divergence</code>:</strong> in order to create a
[many:1] upstream to downstream topology, diverted paths must be labeled
as such. This attribute is 0 for normal (already [many:1]) connections,
1 for the main path through a divergence, and 2 for any diverted
path.</p></li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="a-visual-introduction-to-the-advanced-network-attributes">A visual introduction to the advanced network attributes<a class="anchor" aria-label="anchor" href="#a-visual-introduction-to-the-advanced-network-attributes"></a>
</h2>
<p>To illustrate the above concepts and attributes, we’ll start with the
“New Hope” demo data included in the <code>hydroloom</code> package and
add a toid attribute based on the edge-node topology included in the
data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import data</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hy.html">hy</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/new_hope.gpkg"</span>, package <span class="op">=</span> <span class="st">"hydroloom"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Strip the data back to the required base attributes</span></span>
<span><span class="va">fpath</span> <span class="op">&lt;-</span> <span class="fu">hydroloom</span><span class="fu">::</span><span class="fu"><a href="../reference/add_toids.html">add_toids</a></span><span class="op">(</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">id</span>, <span class="va">fromnode</span>, <span class="va">tonode</span>, <span class="va">divergence</span>, <span class="va">feature_type</span>,</span>
<span>                <span class="va">da_sqkm</span>, <span class="va">length_km</span>, <span class="va">GNIS_ID</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fpath</span> <span class="op">&lt;-</span> <span class="fu">select</span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="va">fpath</span>, <span class="st">"LINESTRING"</span><span class="op">)</span>, </span>
<span>                     <span class="op">-</span><span class="va">tonode</span>, <span class="op">-</span><span class="va">fromnode</span>, <span class="op">-</span><span class="va">divergence</span>, <span class="op">-</span><span class="va">feature_type</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 6 features and 5 fields</span></span>
<span><span class="co">#&gt; Geometry type: LINESTRING</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 1517192 ymin: 1555954 xmax: 1518819 ymax: 1557990</span></span>
<span><span class="co">#&gt; CRS:           unknown</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 6</span></span></span>
<span><span class="co">#&gt;        id    toid da_sqkm length_km GNIS_ID                                 geom</span></span>
<span><span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                       <span style="color: #949494; font-style: italic;">&lt;LINESTRING [m]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 8<span style="text-decoration: underline;">893</span>864 8<span style="text-decoration: underline;">894</span>334  4.81       3.24  991288  (1518702 1557298, 1518643 1557297, …</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 8<span style="text-decoration: underline;">894</span>490 8<span style="text-decoration: underline;">894</span>336  0          0.002 991288    (1517194 1556000, 1517192 1555999)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 8<span style="text-decoration: underline;">894</span>494 8<span style="text-decoration: underline;">894</span>490  0.009      0.102 991288  (1517288 1556038, 1517252 1556023, …</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 8<span style="text-decoration: underline;">894</span>334 8<span style="text-decoration: underline;">894</span>492  0.428      0.073 991288  (1517349 1556090, 1517341 1556077, …</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 8<span style="text-decoration: underline;">894</span>492 8<span style="text-decoration: underline;">894</span>494  0.001<span style="text-decoration: underline;">8</span>     0.008 991288    (1517295 1556041, 1517288 1556038)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 8<span style="text-decoration: underline;">893</span>850 8<span style="text-decoration: underline;">893</span>864  0.406      0.954 991288  (1518668 1557990, 1518699 1557904, …</span></span></code></pre></div>
<div class="section level4">
<h4 id="topo_sort-and-terminal-id">topo_sort and terminal ID<a class="anchor" aria-label="anchor" href="#topo_sort-and-terminal-id"></a>
</h4>
<p>After removing attributes used to generate the <code>toid</code>
attribute, we have a <code>id</code> and <code>toid</code> relation
representing the connectivity of the network as well as attributes
required to generate a sorted network with
<code><a href="../reference/sort_network.html">sort_network()</a></code></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fpath</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sort_network.html">sort_network</a></span><span class="op">(</span><span class="va">fpath</span>, split <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 6 features and 6 fields</span></span>
<span><span class="co">#&gt; Geometry type: LINESTRING</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 1505349 ymin: 1554873 xmax: 1508920 ymax: 1558708</span></span>
<span><span class="co">#&gt; CRS:           unknown</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 7</span></span></span>
<span><span class="co">#&gt;        id   toid da_sqkm length_km GNIS_ID terminal_id                      geom</span></span>
<span><span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;LINESTRING [m]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 8<span style="text-decoration: underline;">898</span>302 8.90<span style="color: #949494;">e</span>6   0.152     0.182 <span style="color: #949494;">"</span>98382…     8<span style="text-decoration: underline;">897</span>784 (1505349 1555718, 150545…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 8<span style="text-decoration: underline;">896</span>658 8.90<span style="color: #949494;">e</span>6   1.19      1.37  <span style="color: #949494;">"</span>98382…     8<span style="text-decoration: underline;">897</span>784 (1505455 1555570, 150547…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 8<span style="text-decoration: underline;">896</span>656 8.90<span style="color: #949494;">e</span>6   3.86      2.64  <span style="color: #949494;">"</span>98382…     8<span style="text-decoration: underline;">897</span>784 (1506375 1554873, 150644…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 8<span style="text-decoration: underline;">896</span>664 8.90<span style="color: #949494;">e</span>6   1.38      1.64  <span style="color: #949494;">"</span> <span style="color: #949494;">"</span>         8<span style="text-decoration: underline;">897</span>784 (1507786 1554903, 150781…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 8<span style="text-decoration: underline;">896</span>624 8.90<span style="color: #949494;">e</span>6   1.34      1.17  <span style="color: #949494;">"</span>98382…     8<span style="text-decoration: underline;">897</span>784 (1508236 1556343, 150825…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 8<span style="text-decoration: underline;">896</span>572 8.90<span style="color: #949494;">e</span>6   1.56      1.77  <span style="color: #949494;">"</span> <span style="color: #949494;">"</span>         8<span style="text-decoration: underline;">897</span>784 (1508311 1558708, 150835…</span></span></code></pre></div>
<p>The <code><a href="../reference/sort_network.html">sort_network()</a></code> function sorts the flowlines such
that headwaters come first and the terminal flowline last. Additionally,
it produces a <code>terminal_id</code> representing the outlet
<code>id</code> of the network. If multiple terminal networks had been
provided, the <code>terminal_id</code> would allow us to group the data
by complete sub networks (a convenient parallelization scheme).</p>
<p>In contrast to NHDPlus, where the terminal path is identified by the
<code>topo_sort</code> <code>id</code> of the outlet flowline (meaning
the outlet of a level path is left to a user to generate),
<code>hydroloom</code> uses the more stable primary <code>id</code>
(COMID in NHDPlus) for identifying outlets to allow the topo_sort
attribute to be generated and discarded as needed.</p>
<p>We can visualize this sorting by assigning a temporary “topo_sort”
value to the sorted network, row wise. Here, we assign the first rows in
the sorted set to large values and the last rows to small values in line
with the topo_sort order convention in NHDPlus.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fpath</span><span class="op">[</span><span class="st">'topo_sort'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">fpath</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fpath</span><span class="op">[</span><span class="st">'topo_sort'</span><span class="op">]</span>, key.pos <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p><img src="advanced_network_files/figure-html/unnamed-chunk-4-1.png" width="288" style="display: block; margin: auto;"></p>
</div>
<div class="section level4">
<h4 id="level-path-and-outlet-id">Level Path and outlet ID<a class="anchor" aria-label="anchor" href="#level-path-and-outlet-id"></a>
</h4>
<p>To generate a levelpath attribute, a “physical” weight is needed to
determine the upstream mainstem at confluences. For this example, we’ll
follow the NHD convention and calculate the arbolate sum explicitly. The
<code><a href="../reference/add_levelpaths.html">add_levelpaths()</a></code> function will add arbolate sum internally
if no weight is explicitly defined.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Rename and compute weight</span></span>
<span><span class="va">fpath</span><span class="op">$</span><span class="va">arbolatesum</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/accumulate_downstream.html">accumulate_downstream</a></span><span class="op">(</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">fpath</span>, </span>
<span>                <span class="va">id</span>, <span class="va">toid</span>, <span class="va">length_km</span><span class="op">)</span>, <span class="st">"length_km"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">fpath</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="va">fpath</span><span class="op">$</span><span class="va">arbolatesum</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p><img src="advanced_network_files/figure-html/unnamed-chunk-5-1.png" width="384" style="display: block; margin: auto;"></p>
<p>A <code>name_attribute</code> identifier can also be provided to
override the physical <code>weight_attribute</code> when a “smaller”
river has the same name. There is an optional
<code>override_factor</code> parameter that signifies if the physical
weight is <code>override_factor</code> times (e.g. 5) larger on an
unnamed or differently named upstream path, the physical weight will be
used in favor of the named <code>id</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get levelpaths</span></span>
<span><span class="va">fpath</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_levelpaths.html">add_levelpaths</a></span><span class="op">(</span><span class="va">fpath</span>, name_attribute <span class="op">=</span> <span class="st">"GNIS_ID"</span>,weight_attribute <span class="op">=</span> <span class="st">"arbolatesum"</span>, </span>
<span>  status <span class="op">=</span> <span class="cn">FALSE</span>, override_factor <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fpath</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 6 features and 10 fields</span></span>
<span><span class="co">#&gt; Geometry type: LINESTRING</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 1514059 ymin: 1551922 xmax: 1518746 ymax: 1554515</span></span>
<span><span class="co">#&gt; CRS:           unknown</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 11</span></span></span>
<span><span class="co">#&gt;        id    toid levelpath_outlet_id topo_sort levelpath</span></span>
<span><span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 8<span style="text-decoration: underline;">897</span>784       0             8<span style="text-decoration: underline;">897</span>784         1         1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 8<span style="text-decoration: underline;">894</span>360 8<span style="text-decoration: underline;">897</span>784             8<span style="text-decoration: underline;">897</span>784         2         1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 8<span style="text-decoration: underline;">894</span>356 8<span style="text-decoration: underline;">894</span>360             8<span style="text-decoration: underline;">897</span>784         3         1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 8<span style="text-decoration: underline;">894</span>354 8<span style="text-decoration: underline;">894</span>356             8<span style="text-decoration: underline;">897</span>784         4         1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 8<span style="text-decoration: underline;">894</span>350 8<span style="text-decoration: underline;">894</span>354             8<span style="text-decoration: underline;">894</span>350         5         5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 8<span style="text-decoration: underline;">893</span>884 8<span style="text-decoration: underline;">894</span>350             8<span style="text-decoration: underline;">894</span>350         6         5</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 6 more variables: geom &lt;LINESTRING [m]&gt;, da_sqkm &lt;dbl&gt;, length_km &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   GNIS_ID &lt;chr&gt;, terminal_id &lt;int&gt;, arbolatesum &lt;dbl&gt;</span></span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fpath</span><span class="op">[</span><span class="st">"topo_sort"</span><span class="op">]</span>, key.pos <span class="op">=</span> <span class="cn">NULL</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fpath</span><span class="op">[</span><span class="st">"levelpath"</span><span class="op">]</span>, key.pos <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p><img src="advanced_network_files/figure-html/levelpath-1.png" width="45%" style="display: block; margin: auto;"><img src="advanced_network_files/figure-html/levelpath-2.png" width="45%" style="display: block; margin: auto;"></p>
<p>Finally, let’s visualize these advanced VAAs!</p>
<p>In the below animation, each newly added level path is shown in blue,
with the outlet flowline colored in red. Remembering that
<code><a href="../reference/sort_network.html">sort_network()</a></code> sorts flowlines such that headwaters come
first and the terminal flowlines last we invert the network so that
level paths fill in from outlet to head waters. For clarity, only
levelpaths with more than 2 flowlines are shown.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Invert plotting order</span></span>
<span><span class="va">fpath</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">fpath</span>, <span class="va">topo_sort</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Level Paths with more then 2 flowlines</span></span>
<span><span class="va">lp</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">fpath</span>, <span class="va">levelpath</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Unique Level Path ID</span></span>
<span><span class="va">lp</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">lp</span><span class="op">$</span><span class="va">levelpath</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Terminal flowline </span></span>
<span><span class="va">terminal_fpath</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">fpath</span>, <span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">terminal_id</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gif_file</span> <span class="op">&lt;-</span> <span class="st">"levelpath.gif"</span></span>
<span></span>
<span><span class="fu">gifski</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gifski/man/gifski.html" class="external-link">save_gif</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">lp</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">lp_plot</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">fpath</span>, <span class="va">levelpath</span> <span class="op">==</span> <span class="va">lp</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">outlet_plot</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">lp_plot</span>, <span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">terminal_id</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">fpath</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">0.5</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">terminal_fpath</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"red"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">fpath</span>, <span class="va">levelpath</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">lp</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">lp_plot</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"blue"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">outlet_plot</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">1.5</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span>, <span class="va">gif_file</span>, delay <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "C:\\Users\\dblodgett\\active_code\\hydroloom\\vignettes\\levelpath.gif"</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html" class="external-link">include_graphics</a></span><span class="op">(</span><span class="va">gif_file</span><span class="op">)</span></span></code></pre></div>
<p><img src="levelpath.gif" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>This entire process of sorting the network and building topo_sort,
levelpath, and derivative variables is wrapped in the nhdplusTools <a href="https://doi-usgs.github.io/nhdplusTools/reference/add_plus_network_attributes.html" class="external-link"><code>add_plus_network_attributes</code></a>
function to provide performance and simplicity. It supports
paralellization and will print status updates in the case when the input
network is very large. <code>add_plus_network_attributes</code> returns
NHDPlus attribute names (truncated per shapefile rules as is done in the
NHDPlus database).</p>
<p>The attributes described in this vignette assume that diversions in
the network have zero flow such that diversions are treated as if they
were headwaters. See the <code><a href="../articles/non-dendritic.html">vignette("non-dendritic")</a></code> for
information about attributes that include connected divergences.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by David Blodgett.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
