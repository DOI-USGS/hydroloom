<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="hydroloom">
<title>NHD Flow Table with Hydroloom • hydroloom</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="NHD Flow Table with Hydroloom">
<meta property="og:description" content="hydroloom">
<meta property="og:image" content="https://doi-usgs.github.io/hydroloom/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">hydroloom</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/hydroloom.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/advanced_network.html">Topological Sort Based Network Attributes</a>
    <a class="dropdown-item" href="../articles/flow-table.html">NHD Flow Table with Hydroloom</a>
    <a class="dropdown-item" href="../articles/non-dendritic.html">Non-dendritic networks</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/DOI-USGS/hydroloom/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<link href="flow-table_files/htmltools-fill-0.5.8/fill.css" rel="stylesheet">
<script src="flow-table_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="flow-table_files/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="flow-table_files/leaflet-1.3.1/leaflet.js"></script><link href="flow-table_files/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="flow-table_files/proj4-2.6.2/proj4.min.js"></script><script src="flow-table_files/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="flow-table_files/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="flow-table_files/leaflet-binding-2.2.2/leaflet.js"></script><script src="flow-table_files/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script><script src="flow-table_files/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script><link href="flow-table_files/HomeButton-0.0.1/home-button.css" rel="stylesheet">
<script src="flow-table_files/HomeButton-0.0.1/home-button.js"></script><script src="flow-table_files/HomeButton-0.0.1/easy-button-src.min.js"></script><script src="flow-table_files/clipboard-0.0.1/setClipboardText.js"></script><link href="flow-table_files/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet">
<link href="flow-table_files/mapviewCSS-0.0.1/mapview.css" rel="stylesheet">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>NHD Flow Table with Hydroloom</h1>
                        <h4 data-toc-skip class="author"><a href="mailto:dblodgett@usgs.gov" class="email">dblodgett@usgs.gov</a></h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DOI-USGS/hydroloom/blob/HEAD/vignettes/flow-table.Rmd" class="external-link"><code>vignettes/flow-table.Rmd</code></a></small>
      <div class="d-none name"><code>flow-table.Rmd</code></div>
    </div>

    
    
<p>This article demonstrates how to work with the NHD flow table using
nhdplusTools and hydroloom.</p>
<p>In this first block, we will download, open, and filter the data to
prepare to work with it as a network.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DOI-USGS/hydroloom" class="external-link">hydroloom</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu">nhdplusTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/nhdplusTools/man/download_nhd.html" class="external-link">download_nhd</a></span><span class="op">(</span><span class="fu">nhdplusTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/nhdplusTools/man/nhdplusTools_data_dir.html" class="external-link">nhdplusTools_data_dir</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>                                  <span class="st">"1908"</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">fs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">dir</span>, pattern <span class="op">=</span> <span class="st">".*1908.*.gdb"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Dropping Z and M and making sure everything is LINESTRING helps later.</span></span>
<span><span class="va">fl</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sf/man/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sf/man/st_zm.html" class="external-link">st_zm</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sf/man/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">fs</span>, <span class="st">"NHDFlowline"</span><span class="op">)</span>, <span class="st">"LINESTRING"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># remove any coastal (ftype 566) features</span></span>
<span><span class="va">fl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">fl</span>, <span class="va">ftype</span> <span class="op">!=</span> <span class="fl">566</span><span class="op">)</span></span></code></pre></div>
<p>Now that we have a network ready to go, we need to figure out a
subset that we want to work with. Here, we’ll use
<code><a href="../reference/index_points_to_lines.html">index_points_to_lines()</a></code> to find a line near the outlet of
the Chena River in Alaska.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># this is a seed point near the outlet of a watershed to consider.</span></span>
<span><span class="va">point</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sf/man/sfc.html" class="external-link">st_sfc</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sf/man/st.html" class="external-link">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">147.911472</span>, <span class="fl">64.796633</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                              crs <span class="op">=</span> <span class="fl">4269</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># now we get the line our point is along.</span></span>
<span><span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/index_points_to_lines.html">index_points_to_lines</a></span><span class="op">(</span><span class="va">fl</span>, <span class="va">point</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Let's see what we have.</span></span>
<span><span class="va">sub</span> <span class="op">&lt;-</span> <span class="va">fl</span><span class="op">[</span><span class="va">fl</span><span class="op">$</span><span class="va">permanent_identifier</span> <span class="op">==</span> <span class="va">i</span><span class="op">$</span><span class="va">permanent_identifier</span>, <span class="op">]</span></span>
<span></span>
<span><span class="fu">mapview</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mapview/man/mapView.html" class="external-link">mapview</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">sub</span>, <span class="va">point</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="leaflet html-widget html-fill-item" id="htmlwidget-9db764e9b59b8dbcf07e" style="width:384px;height:384px;"></div>
<script type="application/json" data-for="htmlwidget-9db764e9b59b8dbcf07e">{"x":{"options":{"minZoom":1,"maxZoom":52,"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"preferCanvas":false,"bounceAtZoomLimits":false,"maxBounds":[[[-90,-370]],[[90,370]]]},"calls":[{"method":"addProviderTiles","args":["CartoDB.Positron","CartoDB.Positron","CartoDB.Positron",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["CartoDB.DarkMatter","CartoDB.DarkMatter","CartoDB.DarkMatter",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenStreetMap","OpenStreetMap","OpenStreetMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["Esri.WorldImagery","Esri.WorldImagery","Esri.WorldImagery",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenTopoMap","OpenTopoMap","OpenTopoMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"createMapPane","args":["line",430]},{"method":"addPolylines","args":[[[[{"lng":[-147.9114829339772,-147.9114834652271,-147.9130392808497,-147.913305547516,-147.9136950808487,-147.9147028808472,-147.9161010141783,-147.9175763475094],"lat":[64.79672267650585,64.79672248067249,64.7960338327569,64.79598169942363,64.79590536609044,64.79587489942384,64.79601356609027,64.79626323275653]}]]],null,"sub",{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"pane":"line","stroke":true,"color":"#6666FF","weight":2,"opacity":0.9,"fill":false,"fillColor":"#6666FF","fillOpacity":1,"smoothFactor":1,"noClip":false},"<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1&emsp;<\/td><\/tr><tr><td>1<\/td><th>permanent_identifier&emsp;<\/th><td>60747901&emsp;<\/td><\/tr><tr><td>2<\/td><th>fdate&emsp;<\/th><td>2021-08-26 19:00:00&emsp;<\/td><\/tr><tr><td>3<\/td><th>resolution&emsp;<\/th><td>2&emsp;<\/td><\/tr><tr><td>4<\/td><th>gnis_id&emsp;<\/th><td>01400201&emsp;<\/td><\/tr><tr><td>5<\/td><th>gnis_name&emsp;<\/th><td>Chena River&emsp;<\/td><\/tr><tr><td>6<\/td><th>lengthkm&emsp;<\/th><td>0.3325898&emsp;<\/td><\/tr><tr><td>7<\/td><th>reachcode&emsp;<\/th><td>19080307008416&emsp;<\/td><\/tr><tr><td>8<\/td><th>flowdir&emsp;<\/th><td>1&emsp;<\/td><\/tr><tr><td>9<\/td><th>wbarea_permanent_identifier&emsp;<\/th><td>{a180abd3-efd7-40d7-a469-9cd1306beb14}&emsp;<\/td><\/tr><tr><td>10<\/td><th>ftype&emsp;<\/th><td>558&emsp;<\/td><\/tr><tr><td>11<\/td><th>fcode&emsp;<\/th><td>55800&emsp;<\/td><\/tr><tr><td>12<\/td><th>mainpath&emsp;<\/th><td>0&emsp;<\/td><\/tr><tr><td>13<\/td><th>innetwork&emsp;<\/th><td>1&emsp;<\/td><\/tr><tr><td>14<\/td><th>visibilityfilter&emsp;<\/th><td>0&emsp;<\/td><\/tr><tr><td>15<\/td><th>SHAPE_Length&emsp;<\/th><td>0.006279804&emsp;<\/td><\/tr><tr><td>16<\/td><th>Enabled&emsp;<\/th><td>1&emsp;<\/td><\/tr><tr><td>17<\/td><th>SHAPE&emsp;<\/th><td>sfc_MULTILINESTRING&emsp;<\/td><\/tr><\/table><\/div>",{"maxWidth":800,"minWidth":50,"autoPan":true,"keepInView":false,"closeButton":true,"closeOnClick":true,"className":""},"1",{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},{"stroke":true,"weight":3,"opacity":1,"fill":false,"fillOpacity":0,"bringToFront":false,"sendToBack":false}]},{"method":"addScaleBar","args":[{"maxWidth":100,"metric":true,"imperial":true,"updateWhenIdle":true,"position":"bottomleft"}]},{"method":"addHomeButton","args":[-147.9175763475094,64.79587489942384,-147.9114829339772,64.79672267650585,true,"sub","Zoom to sub","<strong> sub <\/strong>","bottomright"]},{"method":"addLegend","args":[{"colors":["#6666FF"],"labels":["sub"],"na_color":null,"na_label":"NA","opacity":1,"position":"topright","type":"factor","title":"","extra":null,"layerId":null,"className":"info legend","group":"sub"}]},{"method":"createMapPane","args":["point",440]},{"method":"addCircleMarkers","args":[64.796633,-147.911472,6,null,"point",{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"pane":"point","stroke":true,"color":["function (n) ","{","    grDevices::hcl.colors(n, palette = \"viridis\")","}"],"weight":1,"opacity":0.9,"fill":true,"fillColor":"#6666ff","fillOpacity":0.6},null,null,true,{"maxWidth":800,"minWidth":50,"autoPan":true,"keepInView":false,"closeButton":true,"closeOnClick":true,"className":""},"1",{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addHomeButton","args":[-147.911472,64.796633,-147.911472,64.796633,true,"point","Zoom to point","<strong> point <\/strong>","bottomright"]},{"method":"addLayersControl","args":[["CartoDB.Positron","CartoDB.DarkMatter","OpenStreetMap","Esri.WorldImagery","OpenTopoMap"],["sub","point"],{"collapsed":true,"autoZIndex":true,"position":"topleft"}]},{"method":"addHomeButton","args":[-147.9175763475094,64.79587489942384,-147.911472,64.79672267650585,true,null,"Zoom to full extent","<strong>Zoom full<\/strong>","bottomleft"]}],"limits":{"lat":[64.79587489942384,64.79672267650585],"lng":[-147.9175763475094,-147.9114829339772]},"fitBounds":[64.79587489942384,-147.9175763475094,64.79672267650585,-147.911472,[]]},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (\n      function(el, x, data) {\n      // get the leaflet map\n      var map = this; //HTMLWidgets.find('#' + el.id);\n      // we need a new div element because we have to handle\n      // the mouseover output separately\n      // debugger;\n      function addElement () {\n      // generate new div Element\n      var newDiv = $(document.createElement('div'));\n      // append at end of leaflet htmlwidget container\n      $(el).append(newDiv);\n      //provide ID and style\n      newDiv.addClass('lnlt');\n      newDiv.css({\n      'position': 'relative',\n      'bottomleft':  '0px',\n      'background-color': 'rgba(255, 255, 255, 0.7)',\n      'box-shadow': '0 0 2px #bbb',\n      'background-clip': 'padding-box',\n      'margin': '0',\n      'padding-left': '5px',\n      'color': '#333',\n      'font': '9px/1.5 \"Helvetica Neue\", Arial, Helvetica, sans-serif',\n      'z-index': '700',\n      });\n      return newDiv;\n      }\n\n\n      // check for already existing lnlt class to not duplicate\n      var lnlt = $(el).find('.lnlt');\n\n      if(!lnlt.length) {\n      lnlt = addElement();\n\n      // grab the special div we generated in the beginning\n      // and put the mousmove output there\n\n      map.on('mousemove', function (e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                           ' | zoom: ' + map.getZoom() +\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\n                           ' | epsg: 3857 ' +\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\n      } else {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      }\n      });\n\n      // remove the lnlt div when mouse leaves map\n      map.on('mouseout', function (e) {\n      var strip = document.querySelector('.lnlt');\n      if( strip !==null) strip.remove();\n      });\n\n      };\n\n      //$(el).keypress(67, function(e) {\n      map.on('preclick', function(e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      var txt = document.querySelector('.lnlt').textContent;\n      console.log(txt);\n      //txt.innerText.focus();\n      //txt.select();\n      setClipboardText('\"' + txt + '\"');\n      }\n      });\n\n      }\n      ).call(this.getMap(), el, x, data);\n}","data":null},{"code":"function(el, x, data) {\n  return (function(el,x,data){\n           var map = this;\n\n           map.on('keypress', function(e) {\n               console.log(e.originalEvent.code);\n               var key = e.originalEvent.code;\n               if (key === 'KeyE') {\n                   var bb = this.getBounds();\n                   var txt = JSON.stringify(bb);\n                   console.log(txt);\n\n                   setClipboardText('\\'' + txt + '\\'');\n               }\n           })\n        }).call(this.getMap(), el, x, data);\n}","data":null}]}}</script><p>Now we load up the NHD “flow table” which contains a list of
connections between flowlines. Where there are diversions, the same
“from” will have multiple “to” connections so this table doesn’t join
cleanly to the flowline table. The following code prepares the flow
table and runs a network navigation over it to find all the features we
need.</p>
<p>Note that in <code><a href="../reference/check_hy_graph.html">check_hy_graph()</a></code> we are only finding
flowlines that flow directly into eachother, not loops of three or more
features. We can search for loops like that with the
<code>loop_check</code> flag to <code>check_hy_graph</code> but don’t
need it to get <code><a href="../reference/navigate_network_dfs.html">navigate_network_dfs()</a></code> to work.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># remove coastal and make terminals go to an empty id.</span></span>
<span><span class="va">flow_table</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sf/man/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">fs</span>, <span class="st">"NHDFlow"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">from_permanent_identifier</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">fl</span><span class="op">$</span><span class="va">permanent_identifier</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>to_permanent_identifier <span class="op">=</span> </span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="va">to_permanent_identifier</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">from_permanent_identifier</span>, </span>
<span>                  <span class="st">""</span>, </span>
<span>                  <span class="va">to_permanent_identifier</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remove loops found in navigate network dfs</span></span>
<span><span class="va">remove</span> <span class="op">&lt;-</span> <span class="fu">hydroloom</span><span class="fu">::</span><span class="fu"><a href="../reference/check_hy_graph.html">check_hy_graph</a></span><span class="op">(</span><span class="va">flow_table</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># this is naive and these removals would normally be reviewed.</span></span>
<span><span class="va">flow_table</span> <span class="op">&lt;-</span> <span class="va">flow_table</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>row <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">row</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">remove</span><span class="op">$</span><span class="va">row</span><span class="op">)</span></span>
<span></span>
<span><span class="va">down</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/navigate_network_dfs.html">navigate_network_dfs</a></span><span class="op">(</span><span class="va">flow_table</span>, <span class="va">sub</span><span class="op">$</span><span class="va">permanent_identifier</span>, direction <span class="op">=</span> <span class="st">"down"</span><span class="op">)</span></span>
<span><span class="va">up</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/navigate_network_dfs.html">navigate_network_dfs</a></span><span class="op">(</span><span class="va">flow_table</span>, <span class="va">sub</span><span class="op">$</span><span class="va">permanent_identifier</span>, direction <span class="op">=</span> <span class="st">"up"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">subdown</span> <span class="op">&lt;-</span> <span class="va">fl</span><span class="op">[</span><span class="va">fl</span><span class="op">$</span><span class="va">permanent_identifier</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">down</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">subup</span> <span class="op">&lt;-</span> <span class="va">fl</span><span class="op">[</span><span class="va">fl</span><span class="op">$</span><span class="va">permanent_identifier</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">up</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span><span class="va">map_image</span> <span class="op">&lt;-</span> <span class="st">"flow-table-fig.jpeg"</span></span>
<span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu">mapview</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mapview/man/mapView.html" class="external-link">mapview</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">subup</span>, <span class="va">subdown</span>, <span class="va">point</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">mapview</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mapview/man/mapviewOptions.html" class="external-link">mapviewOptions</a></span><span class="op">(</span>fgb <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">mapview</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mapview/man/mapshot.html" class="external-link">mapshot</a></span><span class="op">(</span><span class="va">map</span>, file <span class="op">=</span> <span class="va">map_image</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html" class="external-link">include_graphics</a></span><span class="op">(</span><span class="va">map_image</span><span class="op">)</span></span></code></pre></div>
<p><img src="flow-table-fig.jpeg" width="496" style="display: block; margin: auto;"></p>
<p>There’s plenty more we could do from here, but this vignette shows
the core of what’s needed to get the NHD flow table working with
hydroloom.</p>
<p>Looking for help or want more in this vignette? Submit an issue at:
<a href="https://github.com/DOI-USGS/hydroloom/issues" class="external-link uri">https://github.com/DOI-USGS/hydroloom/issues</a></p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by David Blodgett.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
